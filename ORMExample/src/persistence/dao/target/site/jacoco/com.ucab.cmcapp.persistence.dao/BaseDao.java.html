<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BaseDao.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">dao</a> &gt; <a href="index.source.html" class="el_package">com.ucab.cmcapp.persistence.dao</a> &gt; <span class="el_source">BaseDao.java</span></div><h1>BaseDao.java</h1><pre class="source lang-java linenums">package com.ucab.cmcapp.persistence.dao;

import com.ucab.cmcapp.common.exceptions.DeleteException;
import com.ucab.cmcapp.common.exceptions.FindAllException;
import com.ucab.cmcapp.common.exceptions.FindException;
import com.ucab.cmcapp.common.exceptions.InsertException;
import com.ucab.cmcapp.common.exceptions.UpdateException;
import com.ucab.cmcapp.persistence.DBHandler;
import com.ucab.cmcapp.properties.Registry;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.persistence.EntityManager;
import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Root;
import java.util.List;
import java.util.Objects;

public abstract class BaseDao&lt;T&gt;
{

    static final int MAX_RESULTS_PER_PAGE =
<span class="nc" id="L24">            Integer.parseInt( Registry.getInstance().getProperty( Registry.MAX_RESULTS_PER_PAGE ) );</span>
    static private DBHandler _dbHandler;
<span class="nc" id="L26">    private static Logger _logger = LoggerFactory.getLogger( BaseDao.class );</span>
    private EntityManager _entityManager;

    public EntityManager getEntityManager()
    {
<span class="nc" id="L31">        return _entityManager;</span>
    }

    public void setEntityManager( EntityManager entityManager )
    {
<span class="nc" id="L36">        _entityManager = entityManager;</span>
<span class="nc" id="L37">    }</span>

    public BaseDao()
<span class="nc" id="L40">    {</span>
<span class="nc bnc" id="L41" title="All 2 branches missed.">        if ( Objects.isNull( _dbHandler ) )</span>
        {
<span class="nc" id="L43">            _dbHandler = new DBHandler();</span>
        }
<span class="nc" id="L45">    }</span>

    public BaseDao( DBHandler handler )
<span class="nc" id="L48">    {</span>
<span class="nc" id="L49">        _dbHandler = handler;</span>
<span class="nc" id="L50">    }</span>

    /**
     * Name:                  update
     * Description:           method for adding a record on the DB
     *
     * @param entity entity
     */
    public T insert( T entity )
    {
<span class="nc" id="L60">        setEntityManager( _dbHandler.getSession() );</span>
        T result;

        //implementar logger

        try
        {
<span class="nc" id="L67">            getEntityManager().persist( entity );</span>
<span class="nc" id="L68">            getEntityManager().flush();</span>
<span class="nc" id="L69">            getEntityManager().refresh( entity );</span>
        }
<span class="nc" id="L71">        catch ( Exception e )</span>
        {
            //implementar logger
<span class="nc" id="L74">            throw new InsertException( e.getMessage() + &quot;Entity: &quot; + entity.toString() );</span>
<span class="nc" id="L75">        }</span>

        //implementar logger
<span class="nc" id="L78">        return entity;</span>
    }


    /**
     * Name:                  insertMultiple
     * Description:           method for adding multiple records in the DB
     *
     * @param entityList entityList
     */
    public List&lt;T&gt; insertMultiple( List&lt;T&gt; entityList )
    {
<span class="nc bnc" id="L90" title="All 2 branches missed.">        for ( T entity : entityList )</span>
        {
<span class="nc" id="L92">            insert( entity );</span>
<span class="nc" id="L93">        }</span>
<span class="nc" id="L94">        return entityList;</span>
    }

    /**
     * Name:                  update
     * Description:           method for updating a record on the DB
     *
     * @param entity entity
     */
    public T update( T entity )
    {
<span class="nc" id="L105">        setEntityManager( _dbHandler.getSession() );</span>
        //implementar logger

        try
        {
<span class="nc" id="L110">            getEntityManager().merge( entity );</span>
<span class="nc" id="L111">            getEntityManager().flush();</span>
        }
<span class="nc" id="L113">        catch ( Exception e )</span>
        {
            //implementar logger
<span class="nc" id="L116">            throw new UpdateException( e, entity.toString() );</span>
<span class="nc" id="L117">        }</span>
        //implementar logger
<span class="nc" id="L119">        return entity;</span>
    }

    /**
     * Name:                  delete
     * Description:           method for deleting a record from the DB
     *
     * @param entity entity
     */
    public T delete(T entity )
    {
<span class="nc" id="L130">        setEntityManager( _dbHandler.getSession() );</span>
        //implementar logger
        try
        {

            //getEntityManager().merge( entity );
            //getEntityManager().flush();
<span class="nc" id="L137">            getEntityManager().remove( getEntityManager().merge( entity ) );</span>
<span class="nc" id="L138">            getEntityManager().flush();</span>

<span class="nc" id="L140">            _logger.debug( &quot;DELETING: {}&quot;,entity);</span>

        }
<span class="nc" id="L143">        catch ( Exception e )</span>
        {
            //implementar logger
<span class="nc" id="L146">            throw new DeleteException( e.getMessage() + &quot;Entity: &quot; + entity.toString() );</span>
<span class="nc" id="L147">        }</span>

        //implementar logger
<span class="nc" id="L150">        return entity;</span>
    }

    /**
     * Name:                  findAll
     * Description:           method for collecting all registers from an entity
     *
     * @param type Class
     *
     * @author teixbr
     * @since 20/10/17
     */
    public List&lt;T&gt; findAll( Class&lt;T&gt; type )
    {
        //implementar logger
<span class="nc" id="L165">        setEntityManager( _dbHandler.getSession() );</span>

<span class="nc" id="L167">        final CriteriaBuilder criteriaBuilder = getEntityManager().getCriteriaBuilder();</span>
<span class="nc" id="L168">        final CriteriaQuery&lt;T&gt; criteriaQuery = criteriaBuilder.createQuery( type );</span>
<span class="nc" id="L169">        final Root&lt;T&gt; root = criteriaQuery.from( type );</span>
        final List&lt;T&gt; list;

        try
        {
<span class="nc" id="L174">            criteriaQuery.select( root );</span>

<span class="nc" id="L176">            list = getEntityManager().createQuery( criteriaQuery ).getResultList();</span>

        }
<span class="nc" id="L179">        catch ( Exception e )</span>
        {
            //implementar logger
<span class="nc" id="L182">            throw new FindAllException( e.getMessage() + &quot; Type&quot; + type.toString() );</span>
<span class="nc" id="L183">        }</span>
        //implementar logger
<span class="nc" id="L185">        return list;</span>
    }

    /**
     * Name:                  find
     * Description:           method used for find a single record by it's ID
     *
     * @param id   id of entity to search
     * @param type Class
     */
    public T find( Long id, Class&lt;T&gt; type )
    {
        //implementar logger
        T entity;

        try
        {
<span class="nc" id="L202">            setEntityManager( _dbHandler.getSession() );</span>
<span class="nc" id="L203">            entity = getEntityManager().find( type, id );</span>
        }
<span class="nc" id="L205">        catch ( Exception e )</span>
        {
            //implementar logger
<span class="nc" id="L208">            throw new FindException( e.getMessage() + &quot;Id: &quot; + id + &quot; Type&quot; + type.toString() );</span>
<span class="nc" id="L209">        }</span>

        //implementar logger
<span class="nc" id="L212">        return entity;</span>
    }

    public void findDelete(Long id, Class&lt;T&gt; type){
        T entity;

<span class="nc" id="L218">        entity = find(id,type);</span>

<span class="nc" id="L220">        delete(entity);</span>
<span class="nc" id="L221">    }</span>

    /**
     * Name:                  getDBHandler
     * Description:           method that returns the daoHandler
     *
     * @return instance of daoHandler
     */
    public DBHandler getDBHandler()
    {
<span class="nc" id="L231">        return _dbHandler;</span>
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>